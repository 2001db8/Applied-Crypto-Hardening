\section{Recommendations on practical settings}


\subsection{Webservers}

\subsubsection{Apache}


Note: a "\textbackslash" (backslash) denotes a line continuation which was wrapped due to formatting reasons here. Do not copy it verbatim.

%-All +TLSv1.1 +TLSv1.2
\begin{lstlisting}[breaklines]
  SSLProtocol All -SSLv2 -SSLv3 
  SSLHonorCipherOrder On
  SSLCompression off
  # Add six earth month HSTS header for all users...
  Header add Strict-Transport-Security "max-age=15768000"
  # If you want to protect all subdomains, use the following header
  # ALL subdomains HAVE TO support https if you use this!
  # Strict-Transport-Security: max-age=15768000 ; includeSubDomains

  SSLCipherSuite  DHE+AESGCM:\
    ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:\
    DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:\
    ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:\
    DHE-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:\
    DHE-DSS-CAMELLIA256-SHA:!ADH:!AECDH:!MD5:!DSS
\end{lstlisting}

Note again, that any cipher suite starting with ECDHE  can be omitted in case of doubt.
%% XXX NOTE TO SELF: remove from future automatically generated lists!

You should redirect everything to httpS:// if possible. In Apache you can do this with the following setting inside of a VirtualHost environment:

\begin{lstlisting}[breaklines]
  <VirtualHost *:80>
   #...
   RewriteEngine On
        RewriteRule ^.*$ https://%{SERVER_NAME}%{REQUEST_URI} [L,R=permanent]
   #...
  </VirtualHost>
\end{lstlisting}

%XXXX   ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AES:RSA+3DES:!ADH:!AECDH:!MD5:!DSS


\subsubsection{lighttpd}



%% Note: need to be checked / reviewed

%% Complete ssl.cipher-list with same algo than Apache
%% Currently this is only the default proposed lighttpd config for SSL
\begin{lstlisting}[breaklines]
  $SERVER["socket"] == "0.0.0.0:443" {
    ssl.engine  = "enable"
    ssl.use-sslv2 = "disable"
    ssl.use-sslv3 = "disable"
    ssl.use-compression = "disable"
    ssl.pemfile = "/etc/lighttpd/server.pem"
    ssl.cipher-list = "DHE+AESGCM:\
      ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:\
      DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:\
      ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:\
      DHE-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:\
      DHE-DSS-CAMELLIA256-SHA:!ADH:!AECDH:!MD5:!DSS"
    ssl.honor-cipher-order = "enable"
  }
\end{lstlisting}

As for any other webserver, you should redirect automatically http traffic toward httpS:\footnote{That proposed configuration is directly coming from lighttpd documentation: \url{http://redmine.lighttpd.net/projects/1/wiki/HowToRedirectHttpToHttps}}

\begin{lstlisting}[breaklines]
  $HTTP["scheme"] == "http" {
    # capture vhost name with regex conditiona -> %0 in redirect pattern
    # must be the most inner block to the redirect rule
    $HTTP["host"] =~ ".*" {
        url.redirect = (".*" => "https://%0$0")
    }
  }
\end{lstlisting}

\subsubsection{nginx}



\begin{lstlisting}[breaklines]
  ssl_prefer_server_ciphers on;
  ssl_protocols -SSLv2 -SSLv3; 
  ssl_ciphers DHE+AESGCM:\
    ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:\
    DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:\
    ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:\
    DHE-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:\
    DHE-DSS-CAMELLIA256-SHA:!ADH:!AECDH:!MD5:!DSS;
  add_header Strict-Transport-Security max-age=2592000;
  add_header X-Frame-Options DENY;
\end{lstlisting}

%% XXX FIXME: do we need to specify dhparams? Parameter: ssl_dhparam = file. See: http://wiki.nginx.org/HttpSslModule#ssl_protocols


If you decide to trust NIST's ECC curve recommendation, you can add the following line to nginx's configuration file to select special curves:

\begin{lstlisting}[breaklines]
  ssl_ecdh_curve          sect571k1;
\end{lstlisting}

You should redirect everything to httpS:// if possible. In Nginx you can do this with the following setting:

\begin{lstlisting}[breaklines]
  rewrite     ^(.*)   https://$host$1 permanent;
\end{lstlisting}

%\subsubsection{openssl.conf settings}

%\subsubsection{Differences in SSL libraries: gnutls vs. openssl vs. others}

\subsubsection{MS IIS}
\label{sec:ms-iis}



When trying to avoid RC4 and CBC (BEAST-Attack) and requiring perfect
forward secrecy, Microsoft Internet Information Server (IIS) supports
ECDSA, but does not support RSA for key exchange (consider ECC suite
B doubts\footnote{\url{http://safecurves.cr.yp.to/rigid.html}}).

Since \verb|ECDHE_RSA_*| is not supported, a SSL certificate based on
elliptic curves needs to be used.

The configuration of cipher suites MS IIS will use can be configured in one
of the following ways:
\begin{enumerate}
\item Group Policy \footnote{\url{http://msdn.microsoft.com/en-us/library/windows/desktop/bb870930(v=vs.85).aspx}}
\item Registry
\item IIS Crypto~\footnote{\url{https://www.nartac.com/Products/IISCrypto/}}
\end{enumerate}


Table~\ref{tab:MS_IIS_Client_Support} shows the process of turning on
one algorithm after another and the effect on the supported Clients
tested using https://www.ssllabs.com.

\verb|SSL 3.0|, \verb|SSL 2.0| and \verb|MD5| are turned off.
\verb|TLS 1.0| and \verb|TLS 2.0| are turned on.

\begin{table}[h]
  \centering
  \small
  \begin{tabular}{|l|l|}
    \hline
    Cipher Suite & Client \\
    \hline
    \verb|TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256| & only IE 10,11, OpenSSL 1.0.1e \\
    \hline
    \verb|TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256| & Chrome 30, Opera 17, Safari 6+ \\
    \hline
    \verb|TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA| & FF 10-24, IE 8+, Safari 5, Java 7\\
    \hline
  \end{tabular}
  \caption{Client support}
  \label{tab:MS_IIS_Client_Support}
\end{table}

Table~\ref{tab:MS_IIS_Client_Support} shows the algoriths from
strongest to weakest and why they need to be added in this order. For
example insiting on SHA-2 algorithms (only first two lines) would
eliminate all versions of Firefox, so the last line is needed to
support this browser, but should be placed at the bottom, so capable
browsers will choose the stronger SHA-2 algorithms.

\verb|TLS_RSA_WITH_RC4_128_SHA| or equivalent should also be added if
MS Terminal Server Connection is used (make sure to use this only in a
trusted environment). This suite will not be used for SSL, since we do
not use a RSA Key.


% \verb|TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256| ... only supported by: IE 10,11, OpenSSL 1.0.1e
% \verb|TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256| ... Chrome 30, Opera 17, Safari 6+
% \verb|TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA| ... Firefox 10-24, IE 8+, Safari 5, Java 7


Not supported Clients:
\begin{enumerate}
\item Java 6
\item WinXP
\item Bing
\end{enumerate}


\subsection{Mail and POP/IMAP Servers}
\subsubsection{Dovecot}



Dovecot 2.2:

% Example: http://dovecot.org/list/dovecot/2013-October/092999.html

\begin{lstlisting}[breaklines]
  ssl_cipher_list = DHE+AESGCM:\
    ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:\
    DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:\
    ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:\
    DHE-DSS-AES256-SHA:DHE-RSA-CAMELLIA256-SHA:\
    DHE-DSS-CAMELLIA256-SHA:!ADH:!AECDH:!MD5:!DSS
  ssl_prefer_server_ciphers = yes
\end{lstlisting}

Dovecot 2.1: Almost as good as dovecot 2.2. Does not support ssl\_prefer\_server\_ciphers


\subsubsection{Cyrus}

\todo{write this subsubsection}

\subsubsection{UW}

\todo{write this subsubsection}

Another option to secure IMAPs servers is to place them behind an stunnel server. 

% XXX config von Adi?
% sslVersion = TLSv1
% ciphers = EDH+CAMELLIA256:EDH+aRSA:+SSLv3:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS:!RC4:!SEED:-AES128:!CAMELLIA128:!ECDSA:AES256-SHA:EDH+AES128;
% options = CIPHER_SERVER_PREFERENCE
% TIMEOUTclose = 1

\subsubsection{Postfix}



First, you need to generate Diffie Hellman parameters (please first take a look at the section \ref{section:PRNG}):

\begin{lstlisting}[breaklines]
  % openssl gendh -out /etc/postfix/dh_param_512.pem -2 512
  % openssl gendh -out /etc/postfix/dh_param_1024.pem -2 1024
\end{lstlisting}

Next, we specify these DH parameters in the postfix config file:

\begin{lstlisting}[breaklines]
  smtpd_tls_dh512_param_file = /etc/postfix/dh_param_512.pem
  smtpd_tls_dh1024_param_file = /etc/postfix/dh_param_1024.pem
\end{lstlisting}

You usually don't want restrictions on the ciphers for opportunistic
encryption, because any encryption is better than plain text. 

For submission (Port 587) or other special cases, however, you want to
enforce strong encryption. In addition to the below entries in
main.cf, you need to enable ``mandatory`` encryption for the
respective service, e.g. by adding ``-o
smtpd\_tls\_security\_level=encrypt'' to the submission smtpd in
master.cf.

% don't -- this influences opportunistic encryption
%  smtpd_tls_protocols = !SSLv2, !SSLv3

\begin{lstlisting}[breaklines]
  smtpd_tls_mandatory_protocols = !SSLv2, !SSLv3
  tls_ssl_options=NO_COMPRESSION
  smtpd_tls_mandatory_ciphers=high
  tls_high_cipherlist=DHE+AESGCM:ECDHE-ECDSA-AES256-SHA384:\
    ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:\
    ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:DHE-DSS-AES256-SHA:\
    DHE-RSA-CAMELLIA256-SHA:DHE-DSS-CAMELLIA256-SHA:!ADH:!AECDH:\
    !MD5:!DSS
  tls_preempt_cipherlist = yes
  tls_random_source = dev:/dev/urandom		
    %% NOTE: might want to have /dev/random here + Haveged
\end{lstlisting}
  
For those users, who want to use ECC key exchange, it is possible to specify this via:
\begin{lstlisting}[breaklines]
  smtpd_tls_eecdh_grade = ultra
\end{lstlisting}

You can check the settings by specifying  smtpd\_tls\_loglevel = 1 and then check the selected ciphers with the following command:
\begin{lstlisting}[breaklines]
$ zegrep "TLS connection established from.*with cipher" /var/log/mail.log | \
> awk '{printf("%s %s %s %s\n", $12, $13, $14, $15)}' | sort | uniq -c | sort -n
      1 SSLv3 with cipher DHE-RSA-AES256-SHA
     23 TLSv1.2 with cipher DHE-RSA-AES256-GCM-SHA384
     60 TLSv1 with cipher ECDHE-RSA-AES256-SHA
    270 TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384
    335 TLSv1 with cipher DHE-RSA-AES256-SHA
\end{lstlisting}

Source: \url{http://www.postfix.org/TLS_README.html}

\subsubsection{SMTP: opportunistic TLS}

\todo{write this subsubsection}

% do we need to documment starttls in detail?
%\subsubsection{starttls?}

\subsection{SSH}

\begin{lstlisting}[breaklines]
	RSAAuthentication yes
	PermitRootLogin no
	StrictModes yes
	HostKey /etc/ssh/ssh_host_rsa_key
	Ciphers aes256-ctr
	MACs hmac-sha2-512,hmac-sha2-256,hmac-ripemd160
	KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256,diffie-hellman-group-exchange-sha1
\end{lstlisting}

% XXX: curve25519-sha256@libssh.org only available upstream(!)
Note: older linux systems won't support SHA2, PuTTY does not support RIPE-MD160.

\subsection{OpenVPN}

\todo{write this subsection}

\subsection{IPSec}
\todo{write this subsection}

\subsection{PGP}

\todo{write this subsection}



%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "applied-crypto-hardening"
%%% End: 
